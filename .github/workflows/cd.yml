name: CD

env:
  IMAGE_NAME_PHP: ebs-php
  IMAGE_NAME_CADDY: ebs-caddy

on:
  push:
    branches:
      - main
    tags: 
      - '*'
  pull_request:
    types: [ opened, reopened, synchronize, labeled ]
  workflow_dispatch: ~

permissions:
  pull-requests: write
  id-token: write
  contents: read
  packages: write

jobs:
  build:
    name: Build
    uses: ./.github/workflows/build.yml

  deploy:
    name: Deploy
    needs: [ build ]
    uses: ./.github/workflows/deploy.yml
    concurrency: ${{ github.ref }}-deploy
    secrets:
      domain: ${{ secrets.DOMAIN }}
      payum-apikey: ${{ secrets.PAYUM_APIKEY }}
      storage-key: ${{ secrets.STORAGE_KEY }}
      storage-secret-key: ${{ secrets.STORAGE_SECRET_KEY}}
      project-id: ${{ secrets.PROJECT_ID }}
      workload-identity-provider: ${{ secrets.WORKLOAD_IDENTITY_PROVIDER }}
      database-url: ${{ secrets.DATABASE_URL }}
      mailer-dsn: ${{ secrets.MAILER_DSN }}
      sms-dsn: ${{ secrets.SMS_DSN }}
